<!DOCTYPE html>
<html>
  <head>
    <title>Update Google Sheet</title>
    <meta charset="utf-8" />
  </head>
  <body>
    <h1>Update "MasterStations" Sheet</h1>

    <button id="authorize_button" style="display: none;">Authorize</button>
    <button id="signout_button" style="display: none;">Sign Out</button>

    <div id="update_form" style="display: none;">
      <p>Enter data to add to the sheet:</p>
      <input type="text" id="data_input" placeholder="Enter a value">
      <button id="submit_button">Update Sheet</button>
    </div>

    <script type="text/javascript">
      const CLIENT_ID = '760459306271-qa4v4b7v1g220bl5dp1rq7k13v12q2td.apps.googleusercontent.com'; // Replace with your OAuth 2.0 Client ID
      const API_KEY = 'AIzaSyCl4liqDZVoMP-f_XoarOK7vVrMrPqX3k0'; // It's recommended to also have an API Key for some operations

      const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
      const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

      const SPREADSHEET_ID = '16pn-NMCeNxR3JbnQ59_QSoL69VUw80pXXhLEyQH88yM';
      const SHEET_NAME = 'MasterStations';

      let tokenClient;
      let gapiInited = false;
      let gisInited = false;

      document.getElementById('authorize_button').style.visibility = 'hidden';
      document.getElementById('signout_button').style.visibility = 'hidden';
      document.getElementById('update_form').style.display = 'none';


      function gapiLoaded() {
        gapi.load('client', intializeGapiClient);
      }

      async function intializeGapiClient() {
        await gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: DISCOVERY_DOCS,
        });
        gapiInited = true;
        maybeEnableButtons();
      }

      function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: '', // defined later
        });
        gisInited = true;
        maybeEnableButtons();
      }

      function maybeEnableButtons() {
        if (gapiInited && gisInited) {
          document.getElementById('authorize_button').style.visibility = 'visible';
        }
      }

      document.getElementById('authorize_button').onclick = handleAuthClick;
      document.getElementById('signout_button').onclick = handleSignoutClick;
      document.getElementById('submit_button').onclick = updateSheet;

      function handleAuthClick() {
        tokenClient.callback = async (resp) => {
          if (resp.error !== undefined) {
            throw (resp);
          }
          document.getElementById('signout_button').style.visibility = 'visible';
          document.getElementById('authorize_button').innerText = 'Refresh';
          document.getElementById('update_form').style.display = 'block';
        };

        if (gapi.client.getToken() === null) {
          tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
          tokenClient.requestAccessToken({prompt: ''});
        }
      }

      function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
          google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken('');
          document.getElementById('update_form').style.display = 'none';
          document.getElementById('signout_button').style.visibility = 'hidden';
          document.getElementById('authorize_button').innerText = 'Authorize';
        }
      }

      async function updateSheet() {
        const valueToAppend = document.getElementById('data_input').value;
        if (!valueToAppend) {
          alert("Please enter a value.");
          return;
        }

        try {
          const response = await gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: SPREADSHEET_ID,
            range: `${SHEET_NAME}!A1`, // Appends after the last row in this range
            valueInputOption: 'USER_ENTERED',
            resource: {
              values: [[valueToAppend]],
            },
          });
          alert('Sheet updated successfully!');
          document.getElementById('data_input').value = '';
        } catch (err) {
          console.error('Error updating sheet:', err);
          alert('An error occurred while updating the sheet.');
        }
      }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
  </body>
</html>
